import React, { useState, useEffect, useMemo } from 'react';
import { 
  Home, 
  Calendar, 
  Compass, 
  Clock, 
  HandMetal, 
  Search, 
  MapPin, 
  Sun, 
  RefreshCcw, 
  ChevronRight, 
  X,
  CheckCircle2,
  Bell,
  Trophy
} from 'lucide-react';

// --- CONSTANTS & DATA ---
const COLORS = {
  bg: '#0A0F1E',
  card: '#161C30',
  primary: '#00E5C0',
  accent: '#FFD700',
  text: '#FFFFFF',
  textSecondary: '#94A3B8'
};

const PRAYER_DATA = [
  { id: 'fajr', name: 'Fajr', nameBn: 'ফজর', time: '05:09 AM', icon: 'Sun' },
  { id: 'dhuhr', name: 'Dhuhr', nameBn: 'যোহর', time: '12:11 PM', icon: 'Sun' },
  { id: 'asr', name: 'Asr', nameBn: 'আসর', time: '03:28 PM', icon: 'Sun', current: true },
  { id: 'maghrib', name: 'Maghrib', nameBn: 'মাগরিব', time: '05:57 PM', icon: 'Moon' },
  { id: 'isha', name: 'Isha', nameBn: 'ইশা', time: '07:13 PM', icon: 'Moon' },
];

const CALENDAR_DATA = [
  { day: 1, date: '18 Feb', sahari: '05:12', iftar: '05:55' },
  { day: 2, date: '19 Feb', sahari: '05:12', iftar: '05:55' },
  { day: 3, date: '20 Feb', sahari: '05:11', iftar: '05:56' },
  { day: 4, date: '21 Feb', sahari: '05:10', iftar: '05:56' },
  { day: 5, date: '22 Feb', sahari: '05:10', iftar: '05:57' },
  { day: 6, date: '23 Feb', sahari: '05:09', iftar: '05:57', active: true },
  { day: 7, date: '24 Feb', sahari: '05:08', iftar: '05:58' },
  { day: 8, date: '25 Feb', sahari: '05:07', iftar: '05:58' },
  { day: 9, date: '26 Feb', sahari: '05:07', iftar: '05:59' },
  { day: 10, date: '27 Feb', sahari: '05:06', iftar: '05:59' },
];

const DHIKR_PRESETS = [
  { en: 'SubhanAllah', ar: 'سُبْحَانَ اللهِ', bn: 'সুবহানাল্লাহ' },
  { en: 'Alhamdulillah', ar: 'الْحَمْدُ لِلَّهِ', bn: 'আলহামদুলিল্লাহ' },
  { en: 'Allahu Akbar', ar: 'اللهُ أَكْبَرُ', bn: 'আল্লাহু আকবার' },
  { en: 'Astaghfirullah', ar: 'أَسْتَغْفِرُ اللهَ', bn: 'আস্তাগফিরুল্লাহ' },
  { en: 'La ilaha illallah', ar: 'لَا إِلَهَ إِلَّا اللهُ', bn: 'লা ইলাহা ইল্লাল্লাহ' },
];

// --- COMPONENTS ---

const App = () => {
  const [activeTab, setActiveTab] = useState('home');
  const [lang, setLang] = useState('en'); // 'en' or 'bn'
  const [tasbihCount, setTasbihCount] = useState(0);
  const [dhikrIndex, setDhikrIndex] = useState(0);
  const [showLocationModal, setShowLocationModal] = useState(false);
  const [location, setLocation] = useState('Chandpur');
  const [timeLeft, setTimeLeft] = useState('04:24:25');

  // Simulated countdown effect
  useEffect(() => {
    const timer = setInterval(() => {
      setTimeLeft(prev => {
        const [h, m, s] = prev.split(':').map(Number);
        let totalSeconds = h * 3600 + m * 60 + s - 1;
        if (totalSeconds < 0) return "00:00:00";
        const nh = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
        const nm = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
        const ns = (totalSeconds % 60).toString().padStart(2, '0');
        return `${nh}:${nm}:${ns}`;
      });
    }, 1000);
    return () => clearInterval(timer);
  }, []);

  const t = (en, bn) => (lang === 'en' ? en : bn);

  const handleTasbihClick = () => {
    setTasbihCount(prev => prev + 1);
    // Vibrate if available
    if (navigator.vibrate) navigator.vibrate(50);
  };

  return (
    <div className="flex flex-col h-screen max-w-md mx-auto bg-[#0A0F1E] text-white font-sans overflow-hidden select-none">
      
      {/* Top Status Bar (Mock) */}
      <div className="flex justify-between items-center px-6 pt-4 pb-2">
        <div className="flex items-center gap-2 cursor-pointer" onClick={() => setShowLocationModal(true)}>
          <div className="w-8 h-8 rounded-full bg-[#161C30] flex items-center justify-center text-[#00E5C0]">
            <MapPin size={16} />
          </div>
          <div>
            <p className="text-[10px] text-slate-400 uppercase tracking-wider font-bold">Location</p>
            <p className="text-sm font-semibold">{location}</p>
          </div>
        </div>
        <div className="flex gap-2">
          <button 
            onClick={() => setLang(lang === 'en' ? 'bn' : 'en')}
            className="w-8 h-8 rounded-full bg-[#161C30] flex items-center justify-center text-[#FFD700] text-[10px] font-bold border border-slate-700"
          >
            {lang.toUpperCase()}
          </button>
          <div className="w-8 h-8 rounded-full bg-[#161C30] flex items-center justify-center text-[#FFD700]">
            <Sun size={16} />
          </div>
        </div>
      </div>

      {/* Main Content Area */}
      <main className="flex-1 overflow-y-auto px-6 py-4 pb-24 scrollbar-hide">
        {activeTab === 'home' && (
          <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <header>
              <h1 className="text-2xl font-bold tracking-tight">{t('Ramadan Mubarak', 'রমজান মোবারক')}</h1>
              <p className="text-[#00E5C0] font-medium">{t('Day 6 • 23 Feb', '৬ষ্ঠ দিন • ২৩ ফেব্রুয়ারি')}</p>
            </header>

            {/* Pulsing Iftar Countdown */}
            <div className="relative overflow-hidden p-6 rounded-[32px] bg-gradient-to-br from-[#00E5C0] to-[#00A389] shadow-xl shadow-teal-900/20">
              <div className="absolute top-0 right-0 p-4 opacity-20">
                <Clock size={80} strokeWidth={1} />
              </div>
              <div className="relative z-10 flex flex-col items-center text-center">
                <p className="text-[10px] font-bold tracking-[0.2em] text-white/80 uppercase">Time Until Iftar</p>
                <h2 className="text-5xl font-black mt-2 mb-4 tracking-tight tabular-nums animate-pulse">
                  {timeLeft}
                </h2>
                
                <div className="w-full h-2 bg-white/20 rounded-full overflow-hidden mb-4">
                  <div className="h-full bg-white rounded-full w-[65%]" />
                </div>

                <div className="flex justify-between w-full text-[11px] font-bold">
                  <span className="opacity-80">Sahari: 05:09 AM</span>
                  <span className="bg-white/20 px-2 py-1 rounded-lg">Iftar: 05:57 PM</span>
                </div>
              </div>
            </div>

            {/* Gamified Streak Card */}
            <div className="p-5 rounded-2xl bg-[#161C30] border border-slate-800 flex items-center gap-4">
              <div className="relative flex items-center justify-center">
                <svg className="w-14 h-14 transform -rotate-90">
                  <circle cx="28" cy="28" r="24" stroke="currentColor" strokeWidth="4" fill="transparent" className="text-slate-800" />
                  <circle cx="28" cy="28" r="24" stroke="currentColor" strokeWidth="4" fill="transparent" strokeDasharray={2 * Math.PI * 24} strokeDashoffset={2 * Math.PI * 24 * (1 - 0.2)} className="text-[#00E5C0]" />
                </svg>
                <span className="absolute text-sm font-black">6</span>
              </div>
              <div className="flex-1">
                <p className="font-bold text-sm flex items-center gap-2">
                  {t('Fasting Streak', 'রোজা রাখার ধারা')} <Trophy size={14} className="text-[#FFD700]" />
                </p>
                <p className="text-xs text-slate-400">{t("You've completed 20% of Ramadan!", "আপনি রমজানের ২০% পূর্ণ করেছেন!")}</p>
              </div>
              <ChevronRight size={18} className="text-slate-600" />
            </div>

            {/* Daily Dua Card */}
            <div className="p-6 rounded-[28px] bg-[#161C30] border border-slate-800">
              <div className="flex items-center gap-2 mb-4 text-[#FFD700]">
                <Sun size={18} />
                <span className="text-xs font-bold uppercase tracking-wider">{t('Suhoor Dua (Niyyah)', 'সাহরির দোয়া (নিয়াত)')}</span>
              </div>
              <p className="text-2xl leading-[1.8] text-[#00E5C0] font-serif text-right dir-rtl mb-4" style={{ fontFamily: 'Amiri, serif' }}>
                نَوَيْتُ أَنْ أَصُومَ غَدًا مِنْ شَهْرِ رَمَضَانَ الْمُبَارَكِ فَرْضًا لَكَ يَا اللهُ فَتَقَبَّلْ مِنِّي إِنَّكَ أَنْتَ السَّمِيْعُ الْعَلِيْمُ
              </p>
              <p className="text-[13px] italic text-slate-400 mb-3 leading-relaxed">
                Nawaitu an asuma ghadan min shahri Ramadanil mubaraki fardan laka ya Allahu, fataqabbal minni innaka antas-sami'ul-'alim.
              </p>
              <p className="text-xs text-slate-500 leading-relaxed">
                {t('I intend to fast tomorrow from the blessed month of Ramadan as an obligation to You, O Allah, so accept it from me. Indeed, You are the All-Hearing, the All-Knowing.', 'আমি আল্লাহর সন্তুষ্টির জন্য আগামীকালের রমজান মাসের রোজা রাখার নিয়ত করছি।')}
              </p>
            </div>
          </div>
        )}

        {activeTab === 'calendar' && (
          <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
            <h2 className="text-2xl font-bold mb-6">{t('Ramadan Calendar', 'রমজান ক্যালেন্ডার')}</h2>
            <div className="rounded-2xl bg-[#161C30] overflow-hidden border border-slate-800">
              <div className="grid grid-cols-4 bg-slate-800/50 p-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                <span>Day</span>
                <span>Date</span>
                <span>Sahari</span>
                <span>Iftar</span>
              </div>
              {CALENDAR_DATA.map((item) => (
                <div key={item.day} className={`grid grid-cols-4 p-4 text-sm items-center border-t border-slate-800/50 ${item.active ? 'bg-[#00E5C0]/10' : ''}`}>
                  <span className={`w-6 h-6 rounded-full flex items-center justify-center font-bold ${item.active ? 'bg-[#00E5C0] text-black' : 'bg-slate-800 text-slate-500'}`}>
                    {item.day}
                  </span>
                  <span className="font-semibold text-slate-300">{item.date}</span>
                  <span className="text-slate-400">{item.sahari}</span>
                  <span className="font-bold text-white">{item.iftar}</span>
                </div>
              ))}
            </div>
          </div>
        )}

        {activeTab === 'qibla' && (
          <div className="flex flex-col items-center justify-center h-full animate-in fade-in zoom-in duration-500 text-center">
             <h2 className="text-2xl font-bold mb-2">{t('Qibla Compass', 'কিবলা কম্পাস')}</h2>
             <p className="text-slate-400 text-sm mb-12">{t('Rotate your device to align', 'সঠিক দিক পেতে আপনার ফোনটি ঘোরান')}</p>
             
             <div className="relative w-72 h-72">
                {/* Compass Background */}
                <div className="absolute inset-0 rounded-full border-4 border-slate-800 bg-[#161C30] flex items-center justify-center">
                  <div className="absolute top-2 font-bold text-slate-500">N</div>
                  <div className="absolute right-2 font-bold text-slate-500">E</div>
                  <div className="absolute bottom-2 font-bold text-slate-500">S</div>
                  <div className="absolute left-2 font-bold text-slate-500">W</div>
                  
                  {/* Outer Rings */}
                  <div className="w-[85%] h-[85%] rounded-full border border-slate-700/50 border-dashed" />
                  <div className="w-[70%] h-[70%] rounded-full border border-slate-700" />
                </div>

                {/* Animated Needle */}
                <div className="absolute inset-0 flex items-center justify-center transition-transform duration-700 ease-out" style={{ transform: 'rotate(293deg)' }}>
                  <div className="relative h-56 w-1 flex flex-col items-center">
                    {/* The Qibla Arrow */}
                    <div className="w-0 h-0 border-l-[12px] border-l-transparent border-r-[12px] border-r-transparent border-b-[30px] border-b-[#00E5C0] mb-[-1px]" />
                    <div className="w-1 flex-1 bg-gradient-to-b from-[#00E5C0] to-transparent" />
                    
                    {/* Kaaba Icon */}
                    <div className="absolute -top-10 flex flex-col items-center">
                       <div className="bg-black w-8 h-8 rounded-sm border border-[#FFD700] flex items-center justify-center shadow-lg">
                          <div className="w-6 h-[2px] bg-[#FFD700] absolute top-2" />
                       </div>
                       <span className="text-[10px] font-bold text-[#00E5C0] mt-1">293° KAABA</span>
                    </div>
                  </div>
                </div>

                {/* Center Hub */}
                <div className="absolute inset-0 flex items-center justify-center">
                  <div className="w-4 h-4 bg-[#0A0F1E] rounded-full border-2 border-[#00E5C0]" />
                </div>
             </div>
          </div>
        )}

        {activeTab === 'prayers' && (
          <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
             <div className="flex justify-between items-center mb-6">
                <h2 className="text-2xl font-bold">{t('Prayer Times', 'নামাজের সময়')}</h2>
                <Bell size={20} className="text-slate-500" />
             </div>
             
             <div className="space-y-4">
                {PRAYER_DATA.map((prayer) => (
                  <div key={prayer.id} className={`p-5 rounded-2xl flex items-center justify-between border transition-all ${prayer.current ? 'bg-[#00E5C0]/5 border-[#00E5C0] shadow-lg shadow-teal-500/10' : 'bg-[#161C30] border-slate-800 opacity-60'}`}>
                    <div className="flex items-center gap-4">
                       <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${prayer.current ? 'bg-[#00E5C0] text-black' : 'bg-slate-800 text-slate-400'}`}>
                          {prayer.icon === 'Sun' ? <Sun size={20} /> : <Compass size={20} />}
                       </div>
                       <div>
                          <p className={`font-bold ${prayer.current ? 'text-white' : 'text-slate-300'}`}>{t(prayer.name, prayer.nameBn)}</p>
                          {prayer.current && <p className="text-[10px] font-bold text-[#00E5C0] uppercase tracking-tighter">Current Prayer</p>}
                       </div>
                    </div>
                    <p className={`text-lg font-bold ${prayer.current ? 'text-[#00E5C0]' : 'text-slate-400'}`}>{prayer.time}</p>
                  </div>
                ))}
             </div>
          </div>
        )}

        {activeTab === 'tasbih' && (
          <div className="flex flex-col h-full animate-in fade-in duration-500">
            <h2 className="text-2xl font-bold mb-2 text-center">{t('Tasbih Counter', 'তাসবিহ')}</h2>
            
            <div className="flex-1 flex flex-col items-center justify-center space-y-12">
               {/* Dhikr Selector Button */}
               <button 
                onClick={() => setDhikrIndex((dhikrIndex + 1) % DHIKR_PRESETS.length)}
                className="bg-[#161C30] border border-slate-800 px-6 py-3 rounded-2xl flex items-center gap-3 active:scale-95 transition-transform"
               >
                  <span className="font-semibold text-sm">{t(DHIKR_PRESETS[dhikrIndex].en, DHIKR_PRESETS[dhikrIndex].bn)}</span>
                  <ChevronRight size={16} className="text-[#00E5C0] rotate-90" />
               </button>

               {/* Arabic Text */}
               <div className="h-20 flex items-center justify-center">
                  <h3 className="text-4xl text-[#00E5C0] font-serif transition-all" style={{ fontFamily: 'Amiri, serif' }}>
                    {DHIKR_PRESETS[dhikrIndex].ar}
                  </h3>
               </div>

               {/* Large Pulsing Counter Button */}
               <div className="relative group" onClick={handleTasbihClick}>
                  {/* Rings */}
                  <div className="absolute inset-[-20px] rounded-full bg-[#00E5C0]/5 group-active:scale-110 transition-transform duration-75" />
                  <div className="absolute inset-[-10px] rounded-full bg-[#00E5C0]/10 group-active:scale-105 transition-transform duration-75" />
                  
                  {/* Main Circle */}
                  <button className="w-56 h-56 rounded-full bg-gradient-to-br from-[#00E5C0] to-[#00A389] shadow-2xl shadow-teal-500/20 flex flex-col items-center justify-center text-white active:scale-95 transition-transform duration-75 border-4 border-white/10">
                    <span className="text-6xl font-black">{tasbihCount}</span>
                    <span className="text-[10px] font-bold tracking-[0.3em] opacity-60 uppercase mt-2">Tap to count</span>
                  </button>
               </div>

               {/* Reset Button */}
               <button 
                onClick={() => setTasbihCount(0)}
                className="flex items-center gap-2 text-slate-500 font-bold text-xs uppercase tracking-widest hover:text-white transition-colors"
               >
                 <RefreshCcw size={14} />
                 {t('Reset Counter', 'পুনরায় সেট করুন')}
               </button>
            </div>
          </div>
        )}
      </main>

      {/* Bottom Navigation */}
      <nav className="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-[#0A0F1E]/80 backdrop-blur-xl border-t border-slate-800/50 px-4 pb-4 pt-2">
        <div className="flex justify-between items-center">
          <NavItem icon={<Home size={22} />} label="Home" active={activeTab === 'home'} onClick={() => setActiveTab('home')} color="#00E5C0" />
          <NavItem icon={<Calendar size={22} />} label="Calendar" active={activeTab === 'calendar'} onClick={() => setActiveTab('calendar')} color="#00E5C0" />
          <NavItem icon={<Compass size={22} />} label="Qibla" active={activeTab === 'qibla'} onClick={() => setActiveTab('qibla')} color="#00E5C0" />
          <NavItem icon={<Clock size={22} />} label="Prayers" active={activeTab === 'prayers'} onClick={() => setActiveTab('prayers')} color="#00E5C0" />
          <NavItem icon={<HandMetal size={22} />} label="Tasbih" active={activeTab === 'tasbih'} onClick={() => setActiveTab('tasbih')} color="#00E5C0" />
        </div>
      </nav>

      {/* Location Modal */}
      {showLocationModal && (
        <div className="fixed inset-0 z-50 flex items-end justify-center bg-black/60 backdrop-blur-sm animate-in fade-in duration-300">
          <div className="bg-[#161C30] w-full max-w-md rounded-t-[32px] p-6 pb-12 animate-in slide-in-from-bottom-full duration-500 border-t border-slate-700">
            <div className="flex justify-between items-center mb-6">
              <h3 className="text-xl font-bold">{t('Change Location', 'অবস্থান পরিবর্তন')}</h3>
              <button onClick={() => setShowLocationModal(false)} className="bg-slate-800 p-2 rounded-full text-slate-400">
                <X size={20} />
              </button>
            </div>

            <button className="w-full flex items-center justify-center gap-3 p-4 rounded-2xl bg-[#00E5C0]/10 border border-[#00E5C0]/30 text-[#00E5C0] font-bold mb-6 active:scale-95 transition-transform">
              <MapPin size={20} />
              {t('Use Current Location', 'বর্তমান অবস্থান ব্যবহার করুন')}
            </button>

            <div className="relative mb-6">
              <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500" size={18} />
              <input 
                type="text" 
                placeholder={t('Enter city name...', 'শহরের নাম লিখুন...')}
                className="w-full bg-[#0A0F1E] border border-slate-700 rounded-2xl py-4 pl-12 pr-4 text-sm focus:outline-none focus:border-[#00E5C0] transition-colors"
              />
            </div>

            <div className="space-y-4">
              <p className="text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em]">{t('Suggestions', 'পরামর্শসমূহ')}</p>
              {['Dhaka, Banglad
